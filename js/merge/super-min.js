/*
   
                                                                              
                              _|                  _|                          
_|      _|      _|    _|_|    _|_|_|      _|_|_|  _|      _|_|_|    _|    _|  
_|      _|      _|  _|_|_|_|  _|    _|  _|    _|  _|      _|    _|  _|    _|  
  _|  _|  _|  _|    _|        _|    _|  _|    _|  _|      _|    _|  _|    _|  
    _|      _|        _|_|_|  _|_|_|      _|_|_|  _|  _|  _|    _|    _|_|_|  
                                              _|                              
                                          _|_|
              by nergal (http://blog.nergal.se)
*/

function Block(){this.active=false;this.color="0xFFFFFF";this.alpha=0;this.r=0;this.g=0;this.b=0;this.wallHeight=0;this.height=0;Block.prototype.Create=function(c,e,d,a,f){this.active=c;this.alpha=f;this.r=e;this.g=d;this.b=a};Block.prototype.setActive=function(a){this.active=a};Block.prototype.isActive=function(){return this.active};Block.prototype.getColor=function(){return parseInt(this.color)}}Block.prototype=new Block();Block.prototype.constructor=Block;function Chunk(){this.blockSize=0.1;this.chunkSize=4;this.chunkSizeX=0;this.chunkSizeY=0;this.chunkSizeZ=0;this.posX=0;this.posY=0;this.posZ=0;this.life=1;this.type="GenericChunk";this.activeBlocks=0;this.mesh=undefined;this.blocks=undefined;this.explodeArray=[];this.explode=false;this.explodeDelta=0;this.explodeSpeed=0.1;this.avgHeight=0;this.box={maxx:0,minx:0,maxz:0,minz:0};this.remove=0;Chunk.prototype.GetAvgHeight=function(){return this.avgHeight};Chunk.prototype.GetBoundingBox=function(){var b=this.posX;var d=this.posX+(this.chunkSizeX*this.blockSize/2);var a=this.posY;var c=this.posY+(this.chunkSizeY*this.blockSize/2);this.box={minx:b,maxx:d,minz:a,maxz:c}};Chunk.prototype.Explode=function(){for(var d=0;d<this.chunkSizeX/2;d++){for(var f=0;f<this.chunkSizeY/2;f++){for(var e=0;e<this.chunkSizeZ;e++){if(this.blocks[d][f][e].isActive()==true){var c=this.blocks[d][f][e];var a=new THREE.Mesh(new THREE.BoxGeometry(this.blockSize/2,this.blockSize/2,this.blockSize/2),new THREE.MeshBasicMaterial({color:new THREE.Color("rgb("+c.r+","+c.g+","+c.b+")").getHex()}));a.position.set(this.mesh.position.x+d*this.blockSize/4,this.mesh.position.z+e*this.blockSize/4,this.mesh.position.y+f*this.blockSize/4);a.dir={x:(Math.random()*this.explodeSpeed)-(this.explodeSpeed/2),y:(Math.random()*this.explodeSpeed)-(this.explodeSpeed/2),z:(Math.random()*this.explodeSpeed)-(this.explodeSpeed/2)};a.life=Math.random()*0.2;game.scene.add(a);this.explodeArray.push(a)}}}}this.explode=true;game.scene.remove(this.mesh);game.objects.push(this)};Chunk.prototype.Draw=function(c,b){if(this.explode){this.explodeDelta+=c;if(this.explodeArray.length==0){this.remove=1}for(var a=0;a<this.explodeArray.length;a++){if(this.explodeArray[a].life<this.explodeDelta/40000){game.scene.remove(this.explodeArray[a]);this.explodeArray.splice(a,1);continue}this.explodeArray[a].position.x+=this.explodeArray[a].dir.x;this.explodeArray[a].position.y+=this.explodeArray[a].dir.y;this.explodeArray[a].position.z+=this.explodeArray[a].dir.z;this.explodeArray[a].rotation.x+=this.explodeArray[a].dir.x;this.explodeArray[a].rotation.y+=this.explodeArray[a].dir.y;this.explodeArray[a].rotation.z+=this.explodeArray[a].dir.z}}};Chunk.prototype.Create=function(){};Chunk.prototype.Rebuild=function(){if(this.NoOfActiveBlocks()<=0){console.log("No active blocks.");return}var n=0;var h=[];var a=[];var d=false;for(var p=0;p<this.chunkSizeX;p++){for(var m=0;m<this.chunkSizeY;m++){for(var k=0;k<this.chunkSizeZ;k++){if(this.blocks[p][m][k].isActive()==true){var e=0;d=false;if(p>0){if(!this.blocks[p-1][m][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=0.8;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(p<this.chunkSize-1){if(!this.blocks[p+1][m][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=0.8;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}if(k>0){if(!this.blocks[p][k][k-1].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=0.8;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(k<this.chunkSize-1){if(!this.blocks[p][m][k+1].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);var o=0.9;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(m<this.chunkSize-1){if(!this.blocks[p][m+1][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=0.8;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(m>0){if(!this.blocks[p][m-1][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);var o=0.8;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}n+=2*e}}}}var l=new THREE.BufferGeometry();var q=new THREE.BufferAttribute(new Float32Array(h.length*3),3);for(var f=0;f<h.length;f++){q.setXYZ(f,h[f][0],h[f][1],h[f][2])}l.addAttribute("position",q);var j=new THREE.BufferAttribute(new Float32Array(a.length*4),4);for(var f=0;f<a.length;f++){j.setXYZW(f,a[f][0]/255,a[f][1]/255,a[f][2]/255,a[f][3]/255)}l.addAttribute("color",j);var g=new THREE.RawShaderMaterial({uniforms:{time:{type:"f",value:1}},vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShader").textContent,transparent:false});var r=new THREE.Mesh(l,g);r.rotation.set(Math.PI/2,Math.PI,0);r.position.set(0,0,0);game.scene.add(r);r.that=this;game.targets.push(r);this.mesh=r;this.GetBoundingBox();Log("Model CREATED TRIANGLES: "+n)};Chunk.prototype.Destroy=function(){var a=((this.mesh.pos.getX()-this.posX)/this.blockSize);var b=((this.mesh.pos.getY()-this.posY)/this.blockSize);if(a>=0&&a<this.blocks.length&&b>=0&&b<this.blocks.length){if(this.blocks[a][b][z].isActive()){this.blocks[a][b][z].setActive(false);this.Rebuild();console.log("Destroy block: "+a+", "+b+", "+z);return true}}return false};Chunk.prototype.getPosY=function(b,e){var a=Math.round(this.box.maxx-b)/(this.blockSize);var d=Math.round(this.box.maxz-e)/(this.blockSize);a=Math.abs(a);d=Math.abs(d);if(a>=0&&a<this.blocks.length&&d>=0&&d<this.blocks[a].length){for(var c=0;c<this.blocks[a][d].length;c++){this.blocks[a][d][c].r=255;this.blocks[a][d][c].g=0;this.blocks[a][d][c].b=0}this.Rebuild();return this.blocks[a][d][0].wallHeight*this.blockSize}else{return 0}};Chunk.prototype.DestroyBlock=function(){};Chunk.prototype.ActivateBlock=function(a,d,c,b){this.blocks[a][d][c].setActive(true);this.blocks[a][d][c].r=b.r;this.blocks[a][d][c].g=b.g;this.blocks[a][d][c].b=b.b;this.blocks[a][d][c].a=b.a};Chunk.prototype.Create=function(c,b,f){this.chunkSizeX=c;this.chunkSizeY=b;this.chunkSizeZ=f;console.log("Create: "+c+", "+b+", "+f);this.blocks=new Array();for(var a=0;a<c;a++){this.blocks[a]=new Array();for(var e=0;e<b;e++){this.blocks[a][e]=new Array();for(var d=0;d<f;d++){this.blocks[a][e][d]=new Block();this.blocks[a][e][d].Create(false,0,0,0,0)}}}};Chunk.prototype.ActivateAll=function(){};Chunk.prototype.NoOfActiveBlocks=function(){var c=0;if(this.blocks!=undefined){for(var a=0;a<this.chunkSizeX;a++){for(var e=0;e<this.chunkSizeY;e++){for(var d=0;d<this.chunkSizeZ;d++){if(this.blocks[a][e][d].isActive()){c++}}}}}return c}}function ChunkWorld(){Chunk.call(this);this.wallHeight=1;ChunkWorld.prototype.Create=function(f,g,c,a,d,b){this.chunkSize=f;this.chunkSizeX=f;this.chunkSizeY=f;this.chunkSizeZ=f;this.blockSize=g;this.posX=c;this.posY=a;this.blocks=new Array();var e=false;for(var k=0;k<this.chunkSize;k++){this.blocks[k]=new Array();for(var j=0;j<this.chunkSize;j++){this.blocks[k][j]=new Array();this.wallHeight=d[k][j].a/b;this.avgHeight+=this.wallHeight;for(var h=0;h<this.chunkSize;h++){e=false;if(d[k][j].a>0&&h<=this.wallHeight){e=true}else{e=false}if(d[k][j].a<255){}this.blocks[k][j][h]=new Block();this.blocks[k][j][h].Create(e,d[k][j].r,d[k][j].g,d[k][j].b,d[k][j].a)}this.blocks[k][j][0].wallHeight=this.wallHeight}}this.avgHeight=this.avgHeight/(this.chunkSize*this.chunkSize)};ChunkWorld.prototype.Rebuild=function(){if(this.NoOfActiveBlocks()<=0){return}var n=0;var h=[];var a=[];var d=false;for(var p=0;p<this.chunkSize;p++){for(var m=0;m<this.chunkSize;m++){var r=0;for(var k=0;k<this.chunkSize;k++){if(this.blocks[p][m][k].isActive()==true){r++;var e=0;d=false;if(p>0){if(!this.blocks[p-1][m][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=1;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(p<this.chunkSize-1){if(!this.blocks[p+1][m][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=0.9;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}if(k>0){if(!this.blocks[p][k][k-1].isActive()){d=true}}else{d=true}d=false;if(d){e++;h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=1;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(k<this.chunkSize-1){if(!this.blocks[p][m][k+1].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);var o=0.95;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(m<this.chunkSize-1){if(!this.blocks[p][m+1][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize]);h.push([p*this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize,k*this.blockSize-this.blockSize]);var o=0.97;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}d=false;if(m>0){if(!this.blocks[p][m-1][k].isActive()){d=true}}else{d=true}if(d){e++;h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize]);h.push([p*this.blockSize-this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);h.push([p*this.blockSize,m*this.blockSize-this.blockSize,k*this.blockSize-this.blockSize]);var o=1;for(var f=0;f<6;f++){a.push([this.blocks[p][m][k].r*o,this.blocks[p][m][k].g*o,this.blocks[p][m][k].b*o,255])}}n+=2*e}}this.blocks[p][m].height=r}}var l=new THREE.BufferGeometry();var q=new THREE.BufferAttribute(new Float32Array(h.length*3),3);for(var f=0;f<h.length;f++){q.setXYZ(f,h[f][0],h[f][1],h[f][2])}l.addAttribute("position",q);var j=new THREE.BufferAttribute(new Float32Array(a.length*4),4);for(var f=0;f<a.length;f++){j.setXYZW(f,a[f][0]/255,a[f][1]/255,a[f][2]/255,a[f][3]/255)}l.addAttribute("color",j);var g=new THREE.RawShaderMaterial({uniforms:{time:{type:"f",value:1}},vertexShader:document.getElementById("vertexShader").textContent,fragmentShader:document.getElementById("fragmentShader").textContent,transparent:true});var s=new THREE.Mesh(l,g);s.rotation.set(Math.PI/2,Math.PI,Math.PI/2);s.position.set(this.posY,0,this.posX);if(this.mesh!=undefined){game.scene.remove(this.mesh)}game.scene.add(s);s.that=this;game.targets.push(s);this.mesh=s;Log(" Chunk World => CREATED TRIANGLES: "+n);this.GetBoundingBox()}}ChunkWorld.prototype=new Chunk();ChunkWorld.prototype.constructor=ChunkWorld;"use strict";function Enemies(){this.type="Enemies";this.mesh=undefined;this.chunk=undefined;this.dir=undefined;this.explodeSpeed=0;Enemies.prototype.Remove=function(a){scene.remove(this.mesh)};Enemies.prototype.Remove=function(a){this.chunk.Explode();this.Remove()};Enemies.prototype.Spawn=function(a,e,d){var c=this;var b=new Vox();b.LoadModel("elf2.vox");setTimeout(function(){b.getChunk().Rebuild();c.chunk=b.getChunk();c.mesh=b.getMesh();c.mesh.position.set(0,(b.getChunk().chunkSizeY*b.getChunk().blockSize)/2-0.5,0);game.objects.push(c);setTimeout(function(){console.log("Explode!");c.chunk.Explode()},3000+Math.random()*7000);c.explodeSpeed=Math.random()*0.5;c.dir={x:(Math.random()*c.explodeSpeed)-(c.explodeSpeed/2),y:(Math.random()*c.explodeSpeed)-(c.explodeSpeed/2),z:(Math.random()*c.explodeSpeed)-(c.explodeSpeed/2)};console.log("Enemies loaded...")},2000)};Enemies.prototype.Draw=function(b,d){var a=(Math.PI/1.5)*d;var c=20*d;this.mesh.position.x+=this.dir.x;this.mesh.position.z+=this.dir.z;this.mesh.rotation.z=Math.random()*1}}Enemies.prototype=new Enemies();Enemies.prototype.constructor=Enemies;"use strict";function Game(){this.container;this.scene;this.camera;this.renderer;this.stats;this.clock;this.controls;this.screenWidth=window.innerWidth;this.screenHeight=window.innerHeight;this.view_angle=45;this.aspect=this.screenWidth/this.screenHeight;this.near=0.1;this.far=80;this.invMaxFps=1/60;this.frameDelta=0;this.updateEnd=0;this.animId=0;this.spectate=1;this.objects=[];this.engines=[];this.targets=[];this.world=undefined;this.projector=undefined;this.rotateY=new THREE.Matrix4().makeRotationY(0.005);this.worldMap=undefined;this.player=undefined;Game.prototype.initScene=function(){this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(this.viewAngle,this.aspect,this.near,this.far);this.scene.add(this.camera)};Game.prototype.Init=function(){this.clock=new THREE.Clock();this.stats=new Stats();$("#stats").append(this.stats.domElement);this.initScene();this.renderer=new THREE.WebGLRenderer({antialias:true});this.renderer.setSize(this.screenWidth,this.screenHeight);this.renderer.setClearColor(0,1);this.keyboard=new THREEx.KeyboardState();this.container=document.getElementById("container");this.container.innerHTML="";this.container.appendChild(this.renderer.domElement);this.projector=new THREE.Projector();THREEx.WindowResize(this.renderer,this.camera);this.renderer.shadowMapEnabled=true;this.camera.position.set(0,0,0);var a=this;this.player=new Player();this.player.Spawn();this.buildScene();this.animate()};Game.prototype.onWindowResize=function(){this.camera.aspect=window.innerWidth/window.innerHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(window.innerWidth,window.innerHeight)};Game.prototype.OnMouseDown=function(f){var d=f.keyCode||f.which;f.preventDefault();if(d===1){console.log("mouse click");if(this.world!=undefined){var a=(f.clientX/window.innerWidth)*2-1;var g=-(f.clientY/window.innerHeight)*2+1;console.log("CLICK: "+a+", "+g);var c=new THREE.Vector3(a,g,1).unproject(game.camera);var b=new THREE.Raycaster();b.ray.set(game.camera.position,c.sub(game.camera.position).normalize());var e=b.intersectObjects(game.targets);if(e.length>0){console.log(e[0].object.that);if(e[0].object.that.type=="GenericChunk"){e[0].object.that.Explode()}}}}};Game.prototype.buildScene=function(){var b=new THREE.SpotLight(16308376);b.position.set(0,100,100);b.intensity=1;game.scene.fog=new THREE.Fog(16777215,1,50);this.world=new World();this.world.Load("maps/christmas.png",25,0.5);this.camera.position.set(0,15,80);var a=this;this.TestParticle()};Game.prototype.TestParticle=function(){var a=new ParticleEngine();a.setValues({positionStyle:Type.CUBE,positionBase:new THREE.Vector3(0,60,0),positionSpread:new THREE.Vector3(200,0,200),velocityStyle:Type.CUBE,velocityBase:new THREE.Vector3(0,-60,0),velocitySpread:new THREE.Vector3(50,20,50),accelerationBase:new THREE.Vector3(0,0,0),angleBase:0,angleSpread:720,angleVelocityBase:0,angleVelocitySpread:60,sizeTween:new Tween([1,1],[1,10]),colorBase:new THREE.Vector3(0.66,1,0.9),opacityTween:new Tween([2,3],[0.8,0]),particlesPerSecond:420,particleDeathAge:1,emitterDeathAge:50,dead:0});a.initialize();this.objects.push(a)};Game.prototype.render=function(){this.renderer.render(this.scene,this.camera)};Game.prototype.animate=function(){this.animId=requestAnimationFrame(this.animate.bind(this));this.render();this.update()};Game.prototype.update=function(){var c=this.clock.getDelta(),b=this.clock.getElapsedTime()*10;this.frameDelta+=c;while(this.frameDelta>=this.invMaxFps){THREE.AnimationHandler.update(this.invMaxFps);for(var a=0;a<this.objects.length;a++){if(this.objects[a]!=undefined){if(this.objects[a].remove==1){this.objects.splice(a,1)}else{this.objects[a].Draw(b,this.invMaxFps,a)}}}this.frameDelta-=this.invMaxFps;if(this.spectate){}}this.stats.update()};Game.prototype.getDistance=function(e,d){var c=e.x-d.x;var b=e.y-d.y;var a=e.z-d.z;return Math.sqrt(c*c+b*b+a*a)}}function Object3D(){this.mesh;this.time;Object3D.prototype.GetObject=function(){return this.mesh};Object3D.prototype.Draw=function(){};Object3D.prototype.AddToScene=function(a){a.add(this.mesh)}}function Plateau(){Object3D.call(this);Plateau.prototype.Create=function(p,m,s,j,h,g,t,r){var f=new THREE.Object3D();var c=[];var b=new THREE.ImageUtils.loadTexture("textures/box_sides_snow.png");var q=new THREE.MeshBasicMaterial({emissive:11184810,color:16777215,specular:0,map:b});c.push(q);c.push(q);c.push(q);c.push(q);var l=new THREE.ImageUtils.loadTexture("textures/box_top_snow.png");l.wrapS=l.wrapT=THREE.RepeatWrapping;l.repeat.set(1,1);c.push(new THREE.MeshBasicMaterial({color:16777215}));var e=new THREE.ImageUtils.loadTexture("textures/box_bottom.png");c.push(new THREE.MeshBasicMaterial({color:16777215,map:e}));var d=new THREE.BoxGeometry(p,m,s,1,1,1,c);d.faceVertexUvs[0][0]=[];d.faceVertexUvs[0][0].push(new THREE.Vector2(0,1));d.faceVertexUvs[0][0].push(new THREE.Vector2(1,1));d.faceVertexUvs[0][0].push(new THREE.Vector2(0,0));d.faceVertexUvs[0][1]=[];d.faceVertexUvs[0][1].push(new THREE.Vector2(1,1));d.faceVertexUvs[0][1].push(new THREE.Vector2(1,0));d.faceVertexUvs[0][1].push(new THREE.Vector2(0,0));d.faceVertexUvs[0][2]=[];d.faceVertexUvs[0][2].push(new THREE.Vector2(1,0));d.faceVertexUvs[0][2].push(new THREE.Vector2(0,0));d.faceVertexUvs[0][2].push(new THREE.Vector2(1,1));d.faceVertexUvs[0][3]=[];d.faceVertexUvs[0][3].push(new THREE.Vector2(0,0));d.faceVertexUvs[0][3].push(new THREE.Vector2(0,1));d.faceVertexUvs[0][3].push(new THREE.Vector2(1,1));d.faceVertexUvs[0][4]=[];d.faceVertexUvs[0][4].push(new THREE.Vector2(1,0));d.faceVertexUvs[0][4].push(new THREE.Vector2(1,1));d.faceVertexUvs[0][4].push(new THREE.Vector2(0,0));d.faceVertexUvs[0][5]=[];d.faceVertexUvs[0][5].push(new THREE.Vector2(0,1));d.faceVertexUvs[0][5].push(new THREE.Vector2(1,1));d.faceVertexUvs[0][5].push(new THREE.Vector2(1,0));var a=new THREE.Mesh(d,new THREE.MeshFaceMaterial(c));a.rotation.x=-Math.PI/2;a.position.set(j+(p/20),-0.1,g-(m/20));a.scale.set(t,t,t);a.receiveShadow=true;f.add(a);var k=THREE.ImageUtils.loadTexture("textures/stone.jpg");k.wrapS=k.wrapT=THREE.RepeatWrapping;k.repeat.set(2,2);var n=new THREE.MeshBasicMaterial({color:16777215,map:k,transparent:false});var o=new THREE.Mesh(new THREE.CylinderGeometry(6,4,15,10,5,true),n);o.position.set(j,h-s-7,g);o.scale.set(t,t,t);f.add(o);this.mesh=f;game.scene.add(f)}}Plateau.prototype=new Object3D();Plateau.prototype.constructor=Plateau;function Water(){Object3D.call(this);Water.prototype.Create=function(f){var a=350;var c=350;var k=new THREE.PlaneGeometry(a,c,128-1,128-1);k.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI/2));k.dynamic=true;var d,b,l,e;for(d=0,l=k.vertices.length;d<l;d++){k.vertices[d].y=0.4*Math.sin(d/2)}k.computeFaceNormals();k.computeVertexNormals();var h=THREE.ImageUtils.loadTexture("textures/water.jpg");h.wrapS=h.wrapT=THREE.RepeatWrapping;h.repeat.set(3,3);var g=new THREE.MeshBasicMaterial({color:52479,map:h,transparent:false,opacity:1});var m=new THREE.Mesh(k,g);m.position.set(0,-10,0);this.mesh=m;f.add(this.mesh)};Water.prototype.Draw=function(c,d,b){for(var b=0,a=this.mesh.geometry.vertices.length;b<a;b++){this.mesh.geometry.vertices[b].y=0.2*Math.sin(b/5+(c+b)/7);this.mesh.geometry.vertices[b].y+=0.3*Math.sin(b/10+(c+b)/4)}this.mesh.geometry.verticesNeedUpdate=true}}Water.prototype=new Object3D();Water.prototype.constructor=Water;function Tween(){this.times=[];this.values=[];Tween.prototype.Create=function(a,b){this.times=a||[];this.values=b||[];return this};Tween.prototype.lerp=function(b){var a=0;var d=this.times.length;while(a<d&&b>this.times[a]){a++}if(a==0){return this.values[0]}if(a==d){return this.values[d-1]}var c=(b-this.times[a-1])/(this.times[a]-this.times[a-1]);if(this.values[0] instanceof THREE.Vector3){return this.values[a-1].clone().lerp(this.values[a],c)}else{return this.values[a-1]+c*(this.values[a]-this.values[a-1])}}}Tween.prototype=new Tween();Tween.prototype.constructor=Tween;var Type=Object.freeze({CUBE:1,SPHERE:2,CHUNK:3});function Particle(){this.position=new THREE.Vector3();this.velocity=new THREE.Vector3();this.acceleration=new THREE.Vector3();this.angle=0;this.angleVelocity=0;this.angleAcceleration=0;this.size=1;this.color=new THREE.Color();this.opacity=1;this.age=0;this.alive=0;this.times=[];this.values=[];this.sizeTween;this.colorTween;this.sizeTween;this.color=undefined;this.mesh=undefined;Particle.prototype.UpdateParticle=function(){if(this.size>0){this.mesh.scale.set(this.size,this.size,this.size)}this.mesh.rotation.x=this.position.x;this.mesh.rotation.y=this.position.y;this.mesh.rotation.z=this.position.z;this.mesh.rotation.x=this.position.x;this.mesh.position.y=this.position.y;this.mesh.position.z=this.position.z};Particle.prototype.Create=function(){var b=new THREE.BoxGeometry(0.1,0.1,0.1);var a=new THREE.MeshBasicMaterial({color:this.color});this.mesh=new THREE.Mesh(b,a);this.mesh.position.x=this.position.x;this.mesh.position.y=this.position.y;this.mesh.position.z=this.position.z;game.scene.add(this.mesh)};Particle.prototype.Destroy=function(){game.scene.remove(this.mesh)};Particle.prototype.update=function(b){this.position.add(this.velocity.clone().multiplyScalar(b));this.velocity.add(this.acceleration.clone().multiplyScalar(b));this.angle+=this.angleVelocity*0.01745329251*b;this.angleVelocity+=this.angleAcceleration*0.01745329251*b;this.age+=b;if(this.sizeTween.times.length>0){this.size=this.sizeTween.lerp(this.age)}if(this.colorTween.times.length>0){var a=this.colorTween.lerp(this.age);this.color=new THREE.Color().setHSL(a.x,a.y,a.z)}if(this.opacityTween.times.length>0){this.opacity=this.opacityTween.lerp(this.age)}}}Particle.prototype=new Particle();Particle.prototype.constructor=Particle;function ParticleEngine(){this.positionBase=new THREE.Vector3();this.positionSpread=new THREE.Vector3();this.positionRadius=0;this.velocityBase=new THREE.Vector3();this.velocitySpread=new THREE.Vector3();this.speedBase=0;this.speedSpread=0;this.accelerationBase=new THREE.Vector3();this.accelerationSpread=new THREE.Vector3();this.angleBase=0;this.angleSpread=0;this.angleVelocityBase=0;this.angleVelocitySpread=0;this.angleAccelerationBase=0;this.angleAccelerationSpread=0;this.sizeBase=0;this.sizeSpread=0;this.sizeTween=new Tween().Create();this.colorBase=new THREE.Vector3(0,1,0.5);this.colorSpread=new THREE.Vector3(0,0,0);this.colorTween=new Tween().Create();this.opacityBase=1;this.opacitySpread=0;this.opacityTween=new Tween().Create();this.particleArray=[];this.blocks=[];this.particlesPerSecond=100;this.particleDeathAge=1;this.dead=0;this.emitterAge=0;this.emitterAlive=true;this.emitterDeathAge=60;this.particleCount=this.particlesPerSecond*Math.min(this.particleDeathAge,this.emitterDeathAge);ParticleEngine.prototype.setValues=function(b){if(b===undefined){return}this.sizeTween=new Tween().Create();this.colorTween=new Tween().Create();this.opacityTween=new Tween().Create();for(var a in b){this[a]=b[a]}Particle.prototype.sizeTween=this.sizeTween;Particle.prototype.colorTween=this.colorTween;Particle.prototype.opacityTween=this.opacityTween;this.particleArray=[];this.emitterAge=0;this.emitterAlive=true;this.particleCount=this.particlesPerSecond*Math.min(this.particleDeathAge,this.emitterDeathAge)};ParticleEngine.prototype.randomValue=function(b,a){return b+a*(Math.random()-0.5)};ParticleEngine.prototype.randomVector3=function(c,b){var a=new THREE.Vector3(Math.random()-0.5,Math.random()-0.5,Math.random()-0.5);return new THREE.Vector3().addVectors(c,new THREE.Vector3().multiplyVectors(b,a))};ParticleEngine.prototype.createParticle=function(d){var f;if(d>=0){f=this.particleArray[d]}else{f=new Particle()}if(this.positionStyle==Type.CUBE){f.position=this.randomVector3(this.positionBase,this.positionSpread)}if(this.positionStyle==Type.SPHERE){var g=2*Math.random()-1;var j=6.2832*Math.random();var a=Math.sqrt(1-g*g);var e=new THREE.Vector3(a*Math.cos(j),a*Math.sin(j),g);f.position=new THREE.Vector3().addVectors(this.positionBase,e.multiplyScalar(this.positionRadius))}else{}if(this.velocityStyle==Type.CUBE){f.velocity=this.randomVector3(this.velocityBase,this.velocitySpread)}if(this.velocityStyle==Type.SPHERE){var h=new THREE.Vector3().subVectors(f.position,this.positionBase);var b=this.randomValue(this.speedBase,this.speedSpread);f.velocity=h.normalize().multiplyScalar(b)}f.acceleration=this.randomVector3(this.accelerationBase,this.accelerationSpread);f.angle=this.randomValue(this.angleBase,this.angleSpread);f.angleVelocity=this.randomValue(this.angleVelocityBase,this.angleVelocitySpread);f.angleAcceleration=this.randomValue(this.angleAccelerationBase,this.angleAccelerationSpread);f.size=this.randomValue(this.sizeBase,this.sizeSpread);var c=this.randomVector3(this.colorBase,this.colorSpread);f.color=new THREE.Color().setHSL(c.x,c.y,c.z);f.opacity=this.randomValue(this.opacityBase,this.opacitySpread);f.age=0;f.alive=0;if(d>=0){}else{f.Create()}return f};ParticleEngine.prototype.initialize=function(){if(this.blocks.length>0){this.particleCount=this.blocks.length;console.log("BLOCKS: "+this.particleCount);for(var a=0;a<this.particleCount;a++){this.particleArray[a]=this.createParticle();this.particleArray[a].color=new THREE.Color("rgb("+this.blocks[a].r+","+this.blocks[a].g+","+this.blocks[a].b+")");this.particleArray[a].position=new THREE.Vector3(this.blocks[a].x,this.blocks[a].y,this.blocks[a].z)}}else{for(var a=0;a<this.particleCount;a++){this.particleArray[a]=this.createParticle()}}};ParticleEngine.prototype.Draw=function(g,e,b){if(this.dead){return}e*=0.1;var d=[];for(var c=0;c<this.particleCount;c++){if(this.particleArray[c].alive){this.particleArray[c].update(e);if(this.particleArray[c].age>this.particleDeathAge){this.particleArray[c].alive=0;d.push(c)}this.particleArray[c].UpdateParticle()}}if(!this.emitterAlive){for(var c=0;c<this.particleArray.length;c++){this.particleArray[c].Destroy()}this.particleArray.splice(0,this.particleArray.length);this.dead=1;return}if(this.emitterAge<this.particleDeathAge){var h=Math.round(this.particlesPerSecond*(this.emitterAge+0));var f=Math.round(this.particlesPerSecond*(this.emitterAge+e));if(f>this.particleCount){f=this.particleCount}for(var c=h;c<f;c++){this.particleArray[c].alive=1}}if(this.velocityStyle==Type.CHUNK){for(var a=0;a<d.length;a++){var c=d[a];this.particleArray[c].Destroy();this.particleArray.splice(c,1)}}else{for(var a=0;a<d.length;a++){var c=d[a];this.particleArray[c]=this.createParticle(c);this.particleArray[c].alive=1}}this.emitterAge+=e;if(this.emitterAge>this.emitterDeathAge){this.emitterAlive=false}};ParticleEngine.prototype.destroy=function(){}}ParticleEngine.prototype=new ParticleEngine();ParticleEngine.prototype.constructor=ParticleEngine;function PhysBlock(){this.opacity=1;this.color="0xFFFFFF";PhysBlock.prototype.Create=function(b,a,c){};PhysBlock.prototype.Draw=function(a,b){};PhysBlock.prototype.Break=function(a,b){};PhysBlock.prototype.getColor=function(){return parseInt(this.color)}}PhysBlock.prototype=new PhysBlock();PhysBlock.prototype.constructor=PhysBlock;"use strict";function Player(){this.type="Player";this.health=100;this.mesh=undefined;this.jump=0;this.jump_power=20;this.t_delta=0;this.camera_obj=0;this.attached_camera=0;this.keyboard=undefined;Player.prototype.Remove=function(a){scene.remove(this.mesh)};Player.prototype.Spawn=function(a,e,d){this.keyboard=new THREEx.KeyboardState();var c=this;var b=new Vox();b.LoadModel("santa2.vox");setTimeout(function(){b.getChunk().Rebuild();c.mesh=b.getMesh();c.mesh.position.set(0,(b.getChunk().chunkSizeY*b.getChunk().blockSize)/2-0.5,0);c.AddBindings();LockPointer();c.camera_obj=new THREE.Object3D();c.mesh.add(c.camera_obj);c.camera_obj.add(game.camera);game.camera.position.set(0,15,4);game.camera.rotation.set(-Math.PI/2,0,Math.PI);c.attached_camera=1;game.objects.push(c);console.log("Player loaded...");c.mesh.position.set(43,5.5,44)},2000)};Player.prototype.Draw=function(b,d){var a=(Math.PI/1.5)*d;var c=10*d;if(this.keyboard.pressed("v")){}if(this.keyboard.pressed("space")){this.jump=1}if(this.keyboard.pressed("m")){}if(this.keyboard.pressed("W")){this.mesh.translateY(-c)}if(this.keyboard.pressed("S")){this.mesh.translateY(c)}if(this.keyboard.pressed("A")){this.mesh.translateX(c)}if(this.keyboard.pressed("D")){this.mesh.translateX(-c)}this.UpdatePos(b)};Player.prototype.UpdatePos=function(e){var c=game.world.chunkSize*game.world.blockSize;var a=Math.floor(Math.abs(this.mesh.position.x)/c);var f=Math.floor(Math.abs(this.mesh.position.z)/c);if(game.worldMap[a][f]==undefined){return}var h=game.worldMap[a][f];var b=Math.round((this.mesh.position.z-game.world.chunkList[h.id].posX)/game.world.blockSize);var d=Math.round((this.mesh.position.x-game.world.chunkList[h.id].posY)/game.world.blockSize);b=Math.abs(b-1);d=Math.abs(d-1);if(game.world.chunkList[h.id]==undefined||game.world.chunkList[h.id].blocks[b][d]==undefined){return}var g=game.world.chunkList[h.id].blocks[b][d].height*game.world.blockSize;if(g>0){this.mesh.position.y=g}};Player.prototype.OnMouseMove=function(b){var e=b.originalEvent;if(this.attached_camera==1){var f=e.movementX||e.mozMovementX||e.webkitMovementX||0;var d=e.movementY||e.mozMovementY||e.webkitMovementY||0;var a=f*0.001;var g=d*0.001;var c=(Math.PI/1.5)*a;this.mesh.rotateOnAxis(new THREE.Vector3(0,0,1),-c);game.camera.rotation.z+=g;game.camera.rotation.z=Math.min(Math.PI+1,Math.max(Math.PI,game.camera.rotation.x))}};Player.prototype.OnMouseUp=function(b){var a=b.keyCode||b.which;if(a===1){this.mouseDown=0;console.log(this.mesh.position)}};Player.prototype.OnMouseDown=function(b){var a=b.keyCode||b.which;if(a===1){}};Player.prototype.RemoveBindings=function(){$(document).unbind("mouseup");$(document).unbind("mousemove");$(document).unbind("mousedown")};Player.prototype.AddBindings=function(){$(document).mouseup(this.OnMouseUp.bind(this));$(document).mousedown(this.OnMouseDown.bind(this));$(document).mousemove(this.OnMouseMove.bind(this))}}Player.prototype=new Player();Player.prototype.constructor=Player;function timeStamp(){var b=new Date();var a=[b.getMonth()+1,b.getDate(),b.getFullYear()];var d=[b.getHours(),b.getMinutes(),b.getSeconds()];d[0]=(d[0]<12)?d[0]:d[0]-12;d[0]=d[0]||12;for(var c=1;c<3;c++){if(d[c]<10){d[c]="0"+d[c]}}return a.join("/")+" "+d.join(":")}function Log(a){if(typeof(a)!="object"){console.log("["+timeStamp()+"] "+a)}else{console.log(a)}}THREE.PerspectiveCamera.prototype.setRotateX=function(a){if(typeof(a)=="number"&&parseInt(a)==a){this.rotation.x=a*(Math.PI/180)}};THREE.PerspectiveCamera.prototype.setRotateY=function(a){if(typeof(a)=="number"&&parseInt(a)==a){this.rotation.y=a*(Math.PI/180)}};THREE.PerspectiveCamera.prototype.setRotateZ=function(a){if(typeof(a)=="number"&&parseInt(a)==a){this.rotation.z=a*(Math.PI/180)}};THREE.PerspectiveCamera.prototype.getRotateX=function(){return Math.round(this.rotation.x*(180/Math.PI))};THREE.PerspectiveCamera.prototype.getRotateY=function(){return Math.round(this.rotation.y*(180/Math.PI))};THREE.PerspectiveCamera.prototype.getRotateZ=function(){return Math.round(this.rotation.z*(180/Math.PI))};function MsgBoard(a){$("#msgboard").fadeIn(1000);$("#msgboard_msg").html("<font color='#FF0000'>"+a+"</font>");setTimeout(function(){$("#msgboard").fadeOut(1000)},2000)}function ExplodeMesh(d){d.attributes={displacement:{type:"v3",value:[]},customColor:{type:"c",value:[]}};d.uniforms={time:{type:"f",value:0}};var m=new THREE.ShaderMaterial({uniforms:d.uniforms,attributes:d.attributes,vertexShader:document.getElementById("vertexshaderExplode").textContent,fragmentShader:document.getElementById("fragmentshaderExplode").textContent,shading:THREE.FlatShading,side:THREE.DoubleSide});var p=d.mesh.geometry.clone();assignUVs(p);p.dynamic=true;THREE.GeometryUtils.center(p);var h=new THREE.ExplodeModifier();h.modify(p);var j=p.vertices;var a=d.attributes.customColor.value;var r=d.attributes.displacement.value;var k,s=0;for(var g=0;g<p.faces.length;g++){var l=p.faces[g];if(l instanceof THREE.Face3){k=3}else{k=4}var q=2*(0.5-Math.random());var o=2*(-0.5-Math.random());var n=2*(0.5-Math.random());for(var c=0;c<k;c++){a[s]=new THREE.Color(47598);r[s]=new THREE.Vector3();r[s].set(q,o,n);s+=1}}mesh=new THREE.Mesh(p,m);mesh.rotation.set(0.5,0.5,0);mesh.scale.set(d.mesh.scale.x/2,d.mesh.scale.y/2,d.mesh.scale.z/2);mesh.doubleSided=true;var b=new THREE.Vector3();b.setFromMatrixPosition(d.mesh.matrixWorld);mesh.position.set(b.x,b.y,b.z);game.scene.remove(d.mesh);d.emesh=mesh;var e=new THREE.Vector3();e.setFromMatrixPosition(d.fish.matrixWorld);d.fish.rotation.set(Math.PI/2,0,0);d.fish.position=e;d.fish.scale.set(0.4,0.4,0.4);game.scene.add(d.fish);d.meshes.push(mesh);game.scene.add(mesh)}function assignUVs(f){f.computeBoundingBox();var g=f.boundingBox.max;var c=f.boundingBox.min;var b=new THREE.Vector2(0-c.x,0-c.y);var d=new THREE.Vector2(g.x-c.x,g.y-c.y);f.faceVertexUvs[0]=[];var a=f.faces;for(i=0;i<f.faces.length;i++){var j=f.vertices[a[i].a];var h=f.vertices[a[i].b];var e=f.vertices[a[i].c];f.faceVertexUvs[0].push([new THREE.Vector2((j.x+b.x)/d.x,(j.y+b.y)/d.y),new THREE.Vector2((h.x+b.x)/d.x,(h.y+b.y)/d.y),new THREE.Vector2((e.x+b.x)/d.x,(e.y+b.y)/d.y)])}f.uvsNeedUpdate=true}function CreateBoundingBox(e){var h=e.mesh;var d=null;h.traverse(function(j){var k=j.geometry;if(k===undefined){return}k.computeBoundingBox();if(d===null){d=k.boundingBox}else{d.union(k.boundingBox)}});var a=d.max.x-d.min.x;var g=d.max.y-d.min.y;var f=d.max.z-d.min.z;e.bbox=d;var c=new THREE.Mesh(new THREE.BoxGeometry(a,g,f),new THREE.MeshNormalMaterial({visible:false,wireframe:true,color:11154227}));var b=d.center();c.translateX(b.x);c.translateY(b.y);c.translateZ(b.z);e.bcube=c;h.add(c);c.that=e.mesh.that;game.targets.push(c)}function rgbToHex(d,c,a){if(d<0){d=0}if(c<0){c=0}return"0x"+componentToHex(d)+componentToHex(c)+componentToHex(a)}function componentToHex(b){var a=b.toString(16);return a.length==1?"0"+a:a}function GetWorldYVector(b){var c=game.terrain.GetNoise();var a=Math.round(b.x/10)+c.length/2;var d=Math.round(b.z/10)+c.length/2;var e=0;if(a<c.length-1){if(c[a]!=undefined&&d<c[a].length-1){e=c[a][d]*200}}else{e=0}return e}function GetWorldY(e){var b=game.terrain.GetNoise();var a=Math.round(e.position.x/10)+b.length/2;var c=Math.round(e.position.z/10)+b.length/2;var d=0;if(a<b.length-1){if(b[a]!=undefined&&c<b[a].length-1){d=b[a][c]*200}}else{d=0}return d}function ReleasePointer(){var a=document.getElementsByTagName("body")[0];a.removeEventListener("click",instrClick);keys_enabled=0;document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock;document.exitPointerLock()}function LockPointer(){var a=document.getElementsByTagName("body")[0];a.addEventListener("click",instrClick,false)}function instrClick(c){var a=document.body;keys_enabled=1;a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock;if(/Firefox/i.test(navigator.userAgent)){var b=function(d){if(document.fullscreenElement===a||document.mozFullscreenElement===a||document.mozFullScreenElement===a){document.removeEventListener("fullscreenchange",b);document.removeEventListener("mozfullscreenchange",b);a.requestPointerLock()}};document.addEventListener("fullscreenchange",b,false);document.addEventListener("mozfullscreenchange",b,false);a.requestFullscreen=a.requestFullscreen||a.mozRequestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullscreen;a.requestFullscreen()}else{a.requestPointerLock()}}function BufferLoader(b,a,c){this.context=b;this.urlList=a;this.onload=c;this.bufferList=new Array();this.loadCount=0}BufferLoader.prototype.loadBuffer=function(c,b){var d=new XMLHttpRequest();d.open("GET",c,true);d.responseType="arraybuffer";var a=this;d.onload=function(){a.context.decodeAudioData(d.response,function(e){if(!e){alert("error decoding file data: "+c);return}a.bufferList[b]=e;if(++a.loadCount==a.urlList.length){a.onload(a.bufferList)}},function(e){console.error("decodeAudioData error",e)})};d.onerror=function(){alert("BufferLoader: XHR error")};d.send()};BufferLoader.prototype.load=function(){for(var a=0;a<this.urlList.length;++a){this.loadBuffer(this.urlList[a],a)}};function VoxelData(){this.x;this.y;this.z;this.color;VoxelData.prototype.Create=function(a,c,b){this.x=(b?a[c]&255/2:a[c++]&255);this.y=(b?a[c]&255/2:a[c++]&255);this.z=(b?a[c]&255/2:a[c++]&255);this.color=a[c]&255}}VoxelData.prototype=new VoxelData();VoxelData.prototype.constructor=VoxelData;function Vox(){this.chunk=undefined;var a=[0,4294967295,4291624959,4288282623,4284940287,4281597951,4278255615,4294954239,4291611903,4288269567,4284927231,4281584895,4278242559,4294941183,4291598847,4288256511,4284914175,4281571839,4278229503,4294928127,4291585791,4288243455,4284901119,4281558783,4278216447,4294915071,4291572735,4288230399,4284888063,4281545727,4278203391,4294902015,4291559679,4288217343,4284875007,4281532671,4278190335,4294967244,4291624908,4288282572,4284940236,4281597900,4278255564,4294954188,4291611852,4288269516,4284927180,4281584844,4278242508,4294941132,4291598796,4288256460,4284914124,4281571788,4278229452,4294928076,4291585740,4288243404,4284901068,4281558732,4278216396,4294915020,4291572684,4288230348,4284888012,4281545676,4278203340,4294901964,4291559628,4288217292,4284874956,4281532620,4278190284,4294967193,4291624857,4288282521,4284940185,4281597849,4278255513,4294954137,4291611801,4288269465,4284927129,4281584793,4278242457,4294941081,4291598745,4288256409,4284914073,4281571737,4278229401,4294928025,4291585689,4288243353,4284901017,4281558681,4278216345,4294914969,4291572633,4288230297,4284887961,4281545625,4278203289,4294901913,4291559577,4288217241,4284874905,4281532569,4278190233,4294967142,4291624806,4288282470,4284940134,4281597798,4278255462,4294954086,4291611750,4288269414,4284927078,4281584742,4278242406,4294941030,4291598694,4288256358,4284914022,4281571686,4278229350,4294927974,4291585638,4288243302,4284900966,4281558630,4278216294,4294914918,4291572582,4288230246,4284887910,4281545574,4278203238,4294901862,4291559526,4288217190,4284874854,4281532518,4278190182,4294967091,4291624755,4288282419,4284940083,4281597747,4278255411,4294954035,4291611699,4288269363,4284927027,4281584691,4278242355,4294940979,4291598643,4288256307,4284913971,4281571635,4278229299,4294927923,4291585587,4288243251,4284900915,4281558579,4278216243,4294914867,4291572531,4288230195,4284887859,4281545523,4278203187,4294901811,4291559475,4288217139,4284874803,4281532467,4278190131,4294967040,4291624704,4288282368,4284940032,4281597696,4278255360,4294953984,4291611648,4288269312,4284926976,4281584640,4278242304,4294940928,4291598592,4288256256,4284913920,4281571584,4278229248,4294927872,4291585536,4288243200,4284900864,4281558528,4278216192,4294914816,4291572480,4288230144,4284887808,4281545472,4278203136,4294901760,4291559424,4288217088,4284874752,4281532416,4278190318,4278190301,4278190267,4278190250,4278190216,4278190199,4278190165,4278190148,4278190114,4278190097,4278251008,4278246656,4278237952,4278233600,4278224896,4278220544,4278211840,4278207488,4278198784,4278194432,4293787648,4292673536,4290445312,4289331200,4287102976,4285988864,4283760640,4282646528,4280418304,4279304192,4293848814,4292730333,4290493371,4289374890,4287137928,4286019447,4283782485,4282664004,4280427042,4279308561];Vox.prototype.getChunk=function(){return this.chunk};Vox.prototype.getMesh=function(){return this.chunk.mesh};Vox.prototype.readInt=function(b,c){return b[c]|(b[c+1]<<8)|(b[c+2]<<16)|(b[c+3]<<24)};Vox.prototype.LoadModel=function(b){var d=new XMLHttpRequest();d.open("GET","models/"+b,true);d.responseType="arraybuffer";var c=this;d.onload=function(s){var o=[];var e=undefined;var j=[];c.chunk=new Chunk();console.log("Loaded model: "+d.responseURL);var G=d.response;if(G){var w=new Uint8Array(G);var p=c.readInt(w,0);var k=c.readInt(w,4);var x=8;while(x<w.length){var h=false;var E=0,C=0,A=0;var t=String.fromCharCode(parseInt(w[x++]))+String.fromCharCode(parseInt(w[x++]))+String.fromCharCode(parseInt(w[x++]))+String.fromCharCode(parseInt(w[x++]));var m=c.readInt(w,x)&255;x+=4;var f=c.readInt(w,x)&255;x+=4;if(t=="SIZE"){E=c.readInt(w,x)&255;x+=4;C=c.readInt(w,x)&255;x+=4;A=c.readInt(w,x)&255;x+=4;if(E>32||C>32){h=true}console.log(b+" => Create VOX Chunk!");c.chunk.Create(E,C,A);x+=m-4*3}else{if(t=="XYZI"){var l=Math.abs(c.readInt(w,x));x+=4;j=new Array(l);for(var v=0;v<j.length;v++){j[v]=new VoxelData();j[v].Create(w,x,h);x+=4}}else{if(t=="RGBA"){console.log(b+" => Regular color chunk");e=new Array(256);for(var v=0;v<256;v++){var q=w[x++]&255;var y=w[x++]&255;var D=w[x++]&255;var F=w[x++]&255;e[v]={r:q,g:y,b:D,a:F}}}else{x+=m}}}}if(j==null||j.length==0){return null}for(var v=0;v<j.length;v++){if(e==undefined){var B=a[Math.abs(j[v].color-1)];var u={b:(B&16711680)>>16,g:(B&65280)>>8,r:(B&255),a:1};c.chunk.ActivateBlock(j[v].x,j[v].y,j[v].z,u)}else{c.chunk.ActivateBlock(j[v].x,j[v].y,j[v].z,e[Math.abs(j[v].color-1)])}}c.chunk}};d.send(null)}}Vox.prototype=new Vox();Vox.prototype.constructor=Vox;function World(){this.width=0;this.height=0;this.name="Unknown";this.map=undefined;this.chunkSize=16;this.chunks=0;this.blocks=0;this.chunkList=[];this.hemiLight=undefined;this.dirLight=undefined;this.wallHeight=15;this.blockSize=0.1;this.mapWidth=0;this.mapHeight=0;World.prototype.Load=function(a,c,b){this.wallHeight=c;this.blockSize=b;this.readWorld(a);this.readMap()};World.prototype.readMap=function(){if(this.map==undefined){var h=this;setTimeout(function(){h.readMap()},500);console.log("loading map...");return}game.worldMap=new Array(this.map.length);for(var g=0;g<game.worldMap.length;g++){game.worldMap[g]=new Array()}this.mapHeight=this.blockSize*this.map.length;this.mapWidth=this.blockSize*this.map.length;for(var d=0;d<this.map.length;d+=this.chunkSize){var e=0;var n=0;var p=new Array();for(var f=0;f<this.map.length;f+=this.chunkSize){var b=0;for(var o=f;o<f+this.chunkSize;o++){p[b]=new Array();var a=0;for(var m=d;m<d+this.chunkSize;m++){if(this.map[o][m]==0){e++}else{this.blocks++}p[b][a++]=this.map[o][m];n++}b++}var l=this.blockSize;if(n!=e){var k=new ChunkWorld();k.Create(this.chunkSize,l,f*l,d*l,p,this.wallHeight);k.Rebuild();this.chunkList.push(k);var j=this.chunks%(this.map.length/this.chunkSize);var o=Math.floor(this.chunks/(this.map.length/this.chunkSize));game.worldMap[o][j]={id:this.chunks,avgHeight:k.GetAvgHeight()};console.log("Z/X: "+o+"/"+j+" => "+this.chunks);this.chunks++;if(this.chunks==15){}Log("Add chunk, blocks: "+this.blocks+" Chunks: "+this.chunks)}else{console.log("=> Skipping invisible chunk.")}}}};World.prototype.readWorld=function(b){var d=new Image();d.src=b;var a=document.createElement("canvas").getContext("2d");var c=this;d.onload=function(){a.canvas.width=d.width;a.canvas.height=d.height;a.drawImage(d,0,0);c.width=d.width;c.height=d.height;c.map=new Array();var l=a.getImageData(0,0,c.width,c.height);game.worldMap=new Array();for(var n=0;n<c.height;n++){var m=n*c.width*4;c.map[n]=new Array();game.worldMap[n]=new Array();for(var f=0;f<c.width;f++){var k=l.data[m++];var j=l.data[m++];var e=l.data[m++];var h=l.data[m++];c.map[n][f]={r:k,g:j,b:e,a:h}}}console.log("Read world complete.")}}}World.prototype=new World();World.prototype.constructor=World;